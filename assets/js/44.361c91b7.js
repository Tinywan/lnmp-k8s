(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{210:function(e,t,r){"use strict";r.r(t);var s=r(0),a=Object(s.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"content"},[r("h1",{attrs:{id:"kubelet"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#kubelet","aria-hidden":"true"}},[e._v("#")]),e._v(" Kubelet")]),e._v(" "),r("h2",{attrs:{id:"初始化步骤"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#初始化步骤","aria-hidden":"true"}},[e._v("#")]),e._v(" 初始化步骤")]),e._v(" "),r("ul",[r("li",[e._v("参考 "),r("code",[e._v("bin/generate-kubelet-bootstrap-kubeconfig.sh")])])]),e._v(" "),r("h2",{attrs:{id:"必须手动-approve-server-cert-csr"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#必须手动-approve-server-cert-csr","aria-hidden":"true"}},[e._v("#")]),e._v(" 必须手动 approve server cert csr")]),e._v(" "),r("p",[r("strong",[e._v("基于安全性考虑，CSR approving controllers 默认不会自动 approve kubelet server 证书签名请求，需要手动 approve。")])]),e._v(" "),r("ul",[r("li",[e._v("https://github.com/opsnull/follow-me-install-kubernetes-cluster/issues/326")])]),e._v(" "),r("p",[e._v("未手动 approve 之前报错如下。")]),e._v(" "),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("bootstrap.go:65"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" Using bootstrap kubeconfig to generate TLS client cert, key and kubeconfig "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v("\n\nbootstrap.go:96"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" No valid private key and/or certificate found, reusing existing private key or creating a new one\n")])])]),r("h3",{attrs:{id:"解决办法"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#解决办法","aria-hidden":"true"}},[e._v("#")]),e._v(" 解决办法")]),e._v(" "),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("$ kubectl get csr\n\nNAME                                                   AGE     REQUESTOR                 CONDITION\ncsr-4gzpq                                              4m20s   system:node:node1         Pending\ncsr-62qp7                                              50m     system:node:node1         Pending\ncsr-6ml4w                                              12m     system:node:node1         Pending\ncsr-8nvc2                                              63m     system:node:node1         Pending\ncsr-f6gbd                                              38m     system:node:node1         Pending\ncsr-sjthd                                              25m     system:node:node1         Pending\ncsr-sxjxf                                              2m41s   system:node:node1         Pending\nnode-csr-j1Ja8wpP3FxFBMnEVNsrwYosgWk_-796bWmRg9cnFTE   63m     system:bootstrap:fp7k2i   Approved,Issued\n\n"),r("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# approve 倒数第二个，例如")]),e._v("\n"),r("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# $ kubectl certificate approve csr-sxjxf")]),e._v("\n$ kubectl certificate approve CSR_NAME\n\n$ kubectl describe csr CSR_NAME\n")])])]),r("h2",{attrs:{id:"特性"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#特性","aria-hidden":"true"}},[e._v("#")]),e._v(" 特性")]),e._v(" "),r("ul",[r("li",[e._v("使用 TLS bootstrap 机制自动生成 client 和 server 证书，过期后自动轮转；")])]),e._v(" "),r("h2",{attrs:{id:"bootstrap-token-auth-和授予权限"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap-token-auth-和授予权限","aria-hidden":"true"}},[e._v("#")]),e._v(" Bootstrap Token Auth 和授予权限")]),e._v(" "),r("p",[r("code",[e._v("kublet")]),e._v(" 启动时查找配置的 "),r("code",[e._v("--kubeletconfig")]),e._v(" 文件是否存在，如果不存在则使用 "),r("code",[e._v("--bootstrap-kubeconfig")]),e._v(" 向 "),r("code",[e._v("kube-apiserver")]),e._v(" 发送证书签名请求 (CSR)。")]),e._v(" "),r("p",[r("code",[e._v("kube-apiserver")]),e._v(" 收到 CSR 请求后，对其中的 Token 进行认证（事先使用 kubeadm 创建的 token），认证通过后将请求的 user 设置为 "),r("code",[e._v("system:bootstrap:")]),e._v("，group 设置为 "),r("code",[e._v("system:bootstrappers")]),e._v("，这一过程称为 Bootstrap Token Auth。")]),e._v(" "),r("p",[e._v("kubelet 启动后使用 "),r("code",[e._v("--bootstrap-kubeconfig")]),e._v(" 向 kube-apiserver 发送 CSR 请求，当这个 CSR 被 approve 后，"),r("code",[e._v("kube-controller-manager")]),e._v(" 为 kubelet 创建 TLS 客户端证书、私钥和 --kubeletconfig 文件。")]),e._v(" "),r("h3",{attrs:{id:"kubelet-client-current-pem"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#kubelet-client-current-pem","aria-hidden":"true"}},[e._v("#")]),e._v(" kubelet-client-current.pem")]),e._v(" "),r("p",[e._v("这是一个软连接文件，当 kubelet 配置了 "),r("code",[e._v("--feature-gates=RotateKubeletClientCertificate=true")]),e._v(" 选项后，会在证书总有效期的 70%~90% 的时间内发起续期请求，请求被批准后会生成一个 "),r("code",[e._v("kubelet-client-时间戳.pem")]),e._v(" "),r("code",[e._v("kubelet-client-current.pem")]),e._v(" 文件则始终软连接到最新的真实证书文件，除首次启动外，kubelet 一直会使用这个证书同 apiserver 通讯")]),e._v(" "),r("h3",{attrs:{id:"kubelet-server-current-pem"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#kubelet-server-current-pem","aria-hidden":"true"}},[e._v("#")]),e._v(" kubelet-server-current.pem")]),e._v(" "),r("p",[e._v("同样是一个软连接文件，当 kubelet 配置了 "),r("code",[e._v("--feature-gates=RotateKubeletServerCertificate=true")]),e._v(" 选项后，会在证书总有效期的 70%~90% 的时间内发起续期请求，请求被批准后会生成一个 "),r("code",[e._v("kubelet-server-时间戳.pem")]),e._v(" "),r("code",[e._v("kubelet-server-current.pem")]),e._v(" 文件则始终软连接到最新的真实证书文件，该文件将会一直被用于 kubelet 10250 api 端口鉴权")]),e._v(" "),r("p",[r("code",[e._v("kubelet-client.crt")]),e._v(" 该文件在 kubelet 完成 TLS bootstrapping 后生成，此证书是由 "),r("code",[e._v("controller-manager")]),e._v(" 签署的，此后 kubelet 将会加载该证书，用于与 apiserver 建立 TLS 通讯，同时使用该证书的 CN 字段作为用户名，O 字段作为用户组向 apiserver 发起其他请求")]),e._v(" "),r("h2",{attrs:{id:"pause"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#pause","aria-hidden":"true"}},[e._v("#")]),e._v(" pause")]),e._v(" "),r("ul",[r("li",[e._v("https://github.com/rootsongjc/kubernetes-handbook/blob/master/concepts/pause-container.md")])])])}],!1,null,null,null);t.default=a.exports}}]);