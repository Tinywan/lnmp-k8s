variant: fcos
version: 1.0.0
systemd:
  units:
    - name: kube-proxy.service
      enabled: true
      contents: |
        [Unit]
        Description=Kubernetes Kube-Proxy Server
        Documentation=https://github.com/kubernetes/kubernetes
        After=network-online.target network.target
        Wants=network-online.target

        [Service]

        ExecStartPre=-/usr/bin/env mkdir -p /var/lib/kube-proxy
        ExecStartPre=-/usr/sbin/modprobe ip_vs
        ExecStartPre=-/sbin/modprobe ip_vs

        # WorkingDirectory=/var/lib/kube-proxy

        Environment="K8S_ROOT=${K8S_ROOT}"

        ExecStart=${K8S_ROOT}/bin/kube-proxy \
        --config=${K8S_ROOT}/conf/kube-proxy.config.yaml \
        --logtostderr=true \
        --v=2

        Restart=on-failure
        RestartSec=5
        LimitNOFILE=65536

        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: ${K8S_ROOT}/conf/kube-proxy.kubeconfig
      mode: 0644
      contents:
        source: http://{{SERVER_HOST}}:8080/cert/kube-proxy.kubeconfig
    - path: ${K8S_ROOT}/bin/kube-proxy
      mode: 0755
      contents:
        source: http://{{SERVER_HOST}}:8080/kubernetes-release/release/{{KUBERNETES_VERSION}}-linux-amd64/kubernetes/server/bin/kube-proxy
